/*!
* Data Aquarium Framework - Data Editor for Touch UI
* Copyright 2018-2021 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function s(n){t.notify({text:n,force:!0})}function l(n){return String.format(it,typeof n=="string"?n:n.HeaderText)}function a(n,t){var r=n.closest(".dv-item"),i;return t==="above"?r.prev(".dv-item").length>0:(i=r.next(".dv-item"),i.length>0&&!i.find(".ui-btn").is(".app-calculated,.dv-action-see-all"))}function rt(){return t.settings("ui.inlineEditing.position")==="top"||t.pointer("touch")}function p(t,i){var r=t.session("targetDataView"),u,f;r&&(u=r.elem,f=u.closest(".dv-item").find(".app-row-status").removeClass("app-row-status-pending app-row-status-error"),i&&f.addClass("app-row-status-"+i),n.sync({dataView:r.id,elem:u,force:!0,scrollIntoView:!0}))}function f(n,i){t.lastTouch(!1);(!n.is(".app-selected")||i)&&(n.length&&t.tapping(!0),n.trigger($.Event("vclick",{ctrlKey:!0})));t.lastTouch(!0)}function d(n){var t=n._id,i=$("#"+t+',[data-for="'+t+'"]').find(".app-row-status-new").closest(".ui-btn");return f(i,!0),!!i.length}function w(n){return n.keyCode||n.which}function g(){i.barcode(":input")||n.activate()}function h(n){var t;return n.length&&(t=n.attr("class").match(/\bapp-field-(\S+)\b/),t&&(t=t[1])),t}function ut(n){var t=[];return n._fields.forEach(function(n){var i=n.Name;n.Type==="DataView"||n.isReadOnly()||t.push(i)}),t}function v(n,i){t.scrollGrid(n,i)}function ft(i,r){var y=r.closest(".app-grid");if(y.length){var o=i.session("grid-avail-width"),e=r.closest(".dv-item"),p=Math.ceil(o-o*(e[0].getBoundingClientRect().width/o)),u=i.session("scroll-left")||0,w=u,l=e.find(".app-frozen").last(),f=n.frame()[0].getBoundingClientRect(),a=f.right,s=e[0].getBoundingClientRect(),h=s.right,c=l.length?l[0].getBoundingClientRect():e.find(".app-frozen-spacer")[0].getBoundingClientRect();if(t.pointer("mouse")&&(h-=6),a>h?u=Math.min(a-h+u+16,p):c&&c.right>f.left?r.is(".app-frozen")||(u=Math.max(u-(c.right-f.left)-16,0)):s.left>f.left&&(u=Math.max(u-(s.left-f.left)-16,0)),w!==u)return v(i,u),!0}}function nt(n){var t=n.isReadOnly();return t&&(i._buffer=null,s(l(n)),i.focus({lastFocused:!0})),t}var u=$app,t=u.touch,i=u.input,n,r=t.fnVisible,c=Web.DataViewResources,b=c.Mobile,tt=c.ModalPopup,it=b.ReadOnly,k,e=u.findDataView,o=t.scrollable,y=t.activePage;u.prototype.inlineEditing=function(n,i){var r=this,u;if(r._inlineEditingChecked||(r._inlineEditingChecked=!0,r.tagged("inline-editing-option-none")?(r.tagged("inline-editing")||r.tagged("inline-editing-when-pointer")&&!t.pointer("touch"))&&r.tag("inline-editing-mode"):(u=r.pageProp("inlineEditing"),u!=null?r.inlineEditing(u):r.tagged("inline-editing")&&!r._lookupInfo&&r.tag("inline-editing-mode"))),arguments.length)n?r.tag("inline-editing-mode"):r.untag("inline-editing-mode"),i!==!1&&r.pageProp("inlineEditing",n);else return!!r.tagged("inline-editing-mode")};n=t.edit={instance:function(){var n=t.dataView();return n&&n._inlineEditor?n:null},frame:function(t){var i=n._frame;return(t===!1&&(i&&i.remove(),n._frame=null),t===":visible")?i&&i[0].style.visibility!=="hidden"&&i.parent().length>0:t===":active"?i&&i[0].style.visibility!=="hidden"&&i.closest(".ui-page-active").length>0:(t==="show"?i&&(i[0].style.visibility="",n.sync({scrollIntoView:!1})):t==="hide"?i&&(i[0].style.visibility="hidden"):i||(i=n._frame=u.html.$span("app-focus-frame")),i)},field:function(t){return arguments.length?n._fieldName==t:n._fieldName},dataView:function(){var t;return n.frame(":visible")&&(t=e(n._dataViewId)),t},fieldElem:function(i){arguments.length||(i=n.dataView());var e,s,u,f;return i&&(s=i.session("dataEditor").fieldName,u=t.pageInfo(),f=">",u&&u.id===i._id||(f='.app-echo[data-for="'+i._id+'"]'),e=o().find(f+" .app-listview .app-selected .app-field-"+s).filter(r)),e},dataItem:function(t){var i=t||n.fieldElem();return i?i.closest(".dv-item"):null},detach:function(t){if(!n._moving&&(!arguments.length||t===!0||n._dataViewId===t)&&!n._active){var i=n._frame;i&&(i.css("visibility","hidden"),t===!0&&(i.closest(".ui-page").find(".app-field-is-selected").removeClass("app-field-is-selected app-field-is-selected2"),i.remove()))}},sync:function(u){var d,ht=n._pending,ut,ct,a,y,b,st;if(!d&&u&&u.reset&&ht&&(ut=ht.editor,ct=e(ut),$("#"+ut).removeClass("app-page-inlineeditor-inactive"),n._pending=null,p(ct,"error"),i.focus({lastFocused:!0}),d=!0),n._pending&&(d=!0),!d){u||(u={});var g=u.elem,l=g,s,nt=u.dataView||n._dataViewId,o=nt?typeof nt=="string"?e(nt):nt:t.toDataView(l),lt,f=u.fieldName;if(o&&o.inlineEditing())if(o.get_isForm()&&!n.instance())n.detach();else{if(t.isInTransition()){n._lastSyncOptions=u;return}if(lt=o.session("dataEditor")||{},l&&l.is(".app-field")?(f||(f=h(l)),b=l=l.closest(".app-listview")):(s=t.scrollable(l),b=t.dataView()===o?l=s.find(".app-listview"):l=s.find('.app-echo[data-for="'+o._id+'"]').find(".app-listview"),b=b.first()),f||(f=lt.fieldName),!f&&o._allFields&&(f=o._allFields[o._fields[0].AliasIndex].Name),f&&(a=g&&g.is(".app-field-"+f)?g:l.find(".dv-item .ui-btn.app-selected .app-field"+(f?"-"+f:"")).filter(r).first(),a.length||(f=o._allFields[o._fields[0].AliasIndex].Name,a=l.find(".dv-item .ui-btn.app-selected .app-field"+(f?"-"+f:"")).filter(r).first()),a.length&&(l.closest(".ui-page-active").length||u.force)&&(s||(s=t.scrollable(a)),f||(f=h(a)),f))){o.session("dataEditor",{fieldName:f});y=a.find(".app-field-data").last();y.length||(y=a);var c=y[0].getBoundingClientRect(),at=s[0].getBoundingClientRect(),v,et,tt=n.frame(),ot=n._dataViewId;if(ot!==o._id&&(n._dataViewId=o._id,ot&&t.summary(ot).find(".app-field-is-selected").removeClass("app-field-is-selected app-field-is-selected2")),tt.parent().is(s)||tt.appendTo(s),u.force!==!0&&u.ignoreOtherInputs!==!0&&$(document.activeElement).closest("[data-input]").length)return;if(y.is(".app-field-type-bool")&&(st=y.parent().height(),c={top:c.top,left:c.left,width:c.width,height:c.height},c.top=c.top-(st-c.height)/2,c.height=st),tt.css("visibility",""),tt.css({left:c.left-at.left-1,top:Math.round(c.top-at.top+s.scrollTop()),width:c.width+2,height:Math.round(c.height)}),u.scrollIntoView&&ft(o,a)){u.scrollIntoView=!1;n.sync(u);return}if(b.is(".app-grid")){et=y.closest(".dv-item");v=!et.prev().is(".dv-item");var vt=b.find(".app-grid-header"),yt=t.dataView()===o?s.closest(".ui-page").find(".dv-heading .app-grid-header"):$(),pt=t.stickyHeaderBar(s),k=vt.find(".app-field-is-selected"),w=yt.find(".app-field-is-selected"),it=pt.find(".app-field-is-selected"),rt;(!k.length&&!w.length||k.length&&(k.attr("data-field-name")!==f||v&&k.is(".app-field-is-selected2")||!v&&!k.is(".app-field-is-selected2"))||w.length&&(w.attr("data-field-name")!==f||v&&w.is(".app-field-is-selected2")||!v&&!w.is(".app-field-is-selected2"))||it.length&&(it.attr("data-field-name")!==f||v&&w.is(".app-field-is-selected2")||!v&&!it.is(".app-field-is-selected2")))&&(k.removeClass("app-field-is-selected app-field-is-selected2"),w.removeClass("app-field-is-selected app-field-is-selected2"),it.removeClass("app-field-is-selected app-field-is-selected2"),rt='[data-field-name="'+f+'"]',vt.find(rt).addClass("app-field-is-selected").toggleClass("app-field-is-selected2",!v),yt.find(rt).addClass("app-field-is-selected").toggleClass("app-field-is-selected2",!v),pt.find(rt).addClass("app-field-is-selected").toggleClass("app-field-is-selected2",!v))}u.scrollIntoView!==!1&&t.makeVisible(n.frame(),s,et);$(".app-data-input").length||s.focus();u.allowToggle&&t.lastTouch()!=null&&a.is(".app-field-type-bool")&&t.touched(a.find("i"))&&!t.busy()&&n.toggleBool(a)}}}},scrollIntoView:function(i){t.makeVisible(n.dataItem(i))},showField:function(f,s,h){if(u.touch.edit.sync({reset:!0}),s!=n._fieldName){var c=f.session("targetDataView"),l=c.elem,a=e(c.id);n._fieldName=s;i.evaluate({dataView:f,row:f.editRow(),fields:[],container:h||o().find('[data-input-container="'+f._id+'"]'),resize:!0});l=l.closest(".dv-item").find(".app-field-"+a._allFields[a.findField(s).AliasIndex].Name).filter(r);c.elem=l;n.sync({dataView:c.id,elem:l,scrollIntoView:!0,force:!0});t.resetPageHeight()}},toSyncKey:function(t){var i=n._pending;return i&&i.dataViewId===t._id&&i.syncKey?i.syncKey:t._syncKey},moveInput:function(u){var p=t.dataView(),vt=p._inlineFields,c=p._availableFields,yt,l=n.field(),ct,o,lt,rt,f=u.direction||"enter",tt,ut,d,s,at,ft,et,ot,it,st,ht;if(t.pointer("touch")&&(f=f==="down"?"right":f==="up"?"left":f),$(document.activeElement).blur(),i.valid()){var k=p.session("targetDataView"),b=k.elem,w=e(k.id),g=b.closest(".dv-item-new").length>0;if(c||(c=p._availableFields=[],yt=[],b.closest(".dv-item").find(".app-field").filter(r).each(function(){var t=this,n=t.className.match(/\bapp\-field\-(.+?)\b/);n&&(n=n[1],n=w.findFieldUnderAlias(n),n&&(n=n.Name,vt.indexOf(n)!==-1&&c.push(n)))})),o=c.indexOf(l),f==="right"?(o++,o>c.length-1&&(o=a(b,"below")||g?0:c.length-1,!g,f="down")):f==="left"?(o--,o<0&&(o=a(b,"above")?c.length-1:0,f="up")):typeof f!="string"&&(o=-1,tt=f.closest(".app-field"),ut=h(tt),ut&&(d=w.findFieldUnderAlias(ut),d&&(o=c.indexOf(d.Name),s=k.elem.closest(".dv-item"),at=tt.closest(".dv-item"),s.is(at)?nt(d)?o=-1:f="field":(f=tt,ct=d.Name)))),l=c[o]||ct,l)if(f==="right"||f==="left"||f==="field")n.showField(p,l),i.focus({fieldName:l});else{if(f==="down"||f==="up")if(s=b.closest(".dv-item"),s=f==="down"?s.next():s.prev(),s=s.find(".ui-btn"),g||s.is(".app-calculated")||!s.is(":visible"))if(g){if(et=b.closest(".dv-item").prev().find(".ui-btn"),ot=et.length?et.data("data-context"):null,o!==0&&(l=c[0],v(w,0),n.showField(p,l)),ot)for(f=ot.row,rt=[],st=w._keyFields,it=0;it<st.length;it++)rt.push(f[st[it].Index]);f="new"}else f="enter";else ft=s.find(".app-field-"+l),ft.length&&(f=ft);y().addClass("app-page-inlineeditor-inactive");typeof f=="string"||Array.isArray(f)||(n.sync({dataView:w,elem:f,force:!0,scrollIntoView:!0}),f=f.closest(".ui-btn").data("dataContext"),f&&(f=f.row));ht=n._pending={editor:p._id,pageId:n.frame().closest(".ui-page").attr("id"),dataViewId:k.id,action:p.changed()?"post":"cancel",field:w._allFields[w.findField(l).AliasIndex].Name,originalField:l,direction:f,syncKey:rt};lt=k.elem.closest(".dv-item").find(".app-row-status");ht.action==="cancel"?(ht.syncKey=null,t.goBack()):(lt.addClass("app-row-status-pending"),t.executeInContext())}}u.preventDefault()},syncKey:function(t){var i=n._pending;return i&&t._id===i.dataViewId?i.syncKey:null},_broadcastValues:function(t,i){var u=t.session("targetDataView");if(u){var o=u.elem,f=o.closest(".dv-item"),s=f.closest(".app-grid").length>0;i.forEach(function(n){var i=t.findField(n.name||n.Name),u=n.name?"newValue"in n?n.newValue:n.value:"NewValue"in n?n.NewValue:n.Value,e;i&&f.find(".app-field-"+i.Name).filter(r).each(function(){var t=$(this),n,f=t.data("inline-undo"),r;f==null&&t.data("inline-undo",{html:t.html(),isNull:t.closest(".app-null").length>0});e=i.text(u);n=t.find(".app-field-data");n.length||(n=t);n.toggleClass("app-null",u==null);r=n.find(".material-icon-check-box,.material-icon-check-box-outline-blank");r.length&&!u?r.text("check_box_outline_blank").addClass("material-icon-check-box-outline-blank").removeClass("material-icon-check-box"):r.length&&u?r.text("check_box").addClass("material-icon-check-box").removeClass("material-icon-check-box-outline-blank"):i.htmlEncode()?n.text(e):n.html(e)})});n.sync({dataView:e(u.id),elem:o,force:!0,scrollIntoView:!0});f.find(".app-row-status:not(.app-row-status-new)").addClass("app-row-status-edit")}},undo:function(i){i||(i=t.dataView());var r=i.session("targetDataView"),u=r.elem.closest(".dv-item");u.find(".app-field").each(function(){var n=$(this),t=n.data("inline-undo");t!=null&&(n.removeData("inline-undo"),n.html(t.html),n.find(".app-field-data").length||n.toggleClass("app-null",t.isNull))});u.find(".app-row-status").removeClass("app-row-status-edit");n.sync({dataView:n._dataViewId,elem:r.elem,force:!0})},commit:function(i){function v(){var v=r==="down",c=!r||r==="enter",y=r==="new",i=e(u.dataViewId),p,a,w,o;s==="post"&&i._busy()||(n._pending=null,r==="new"&&(r=new Array(i._allFields.length)),r==="up"||v||c?(n.sync({dataView:i,fieldName:h,scrollIntoView:!0}),c||l.trigger($.Event("keydown",{keyCode:v?40:38})),(n._fieldName!==u.originalField||c)&&n.sync({dataView:i,fieldName:h,scrollIntoView:!0})):r&&Array.isArray(r)&&(i.session("dataEditor").fieldName=h,p=n.fieldElem(i),a=$(p).closest(".app-listview"),a.find(".dv-item .ui-btn").each(function(){var n=$(this),l=n.data("data-context"),o,s,e,h,c,a;if(l&&(o=l.row,o)){for(s=!0,h=i._keyFields,e=0;e<h.length;e++)if(c=h[e].Index,r[c]!=o[c]){s=!1;break}if(s)return u.syncKey&&!y?(n.addClass("app-selected"),f(n,!0),a=n.parent().nextAll(".dv-item-new"),f(a.find(".ui-btn"),!0),t.stickyHeaderBar().hide(),t.stickyHeader()):f(n.removeClass("app-selected")),w=!0,!1}}),!w&&y&&(o=t.summary(a),o.length&&(t.lastTouch(!1),o.find(".dv-action-see-all .app-btn-next").trigger($.Event("vclick",{feedback:!1})),t.lastTouch(!0),f(o.find(".app-listview .dv-item-new .ui-btn"))))),l.focus())}var u=n._pending,c,a,l,s,h,r;if(u&&(a=y().attr("id"),u.pageId===a))if(l=o(),s=u.action,r=u.direction,c=i.type,h=u.field,s==="cancel"&&c==="pagereadycomplete")v();else if(s==="post"&&c==="dataviewrefresh")v();else return},move:function(u){function ot(){s instanceof jQuery||(s=$(s));t.tooltip(!1);n.sync({dataView:k,elem:s,scrollIntoView:et});tt||(s=null)}var ft,st,ht;if(n._moving)return!0;n._moving=!0;typeof u=="string"&&(u={direction:u});var h=u.direction,g=u.originalEvent,ut=g.shiftKey,it=g.ctrlKey,lt=g.metaKey,k=n.dataView(),s=n.fieldElem(k),y,tt,et,p,l,b,nt;switch(h){case"pageup":case"pagedown":return c=o().focus().find('.app-focus[data-input="dataview"]'),c.length&&(n.frame("hide"),t.summary(c).find(".dv-action-see-all .app-btn-"+(h==="pageup"?"prev":"next")+":not(.app-btn-disabled)").trigger($.Event("vclick",{feedback:!1})),n.sync(),y=!0),n._moving=!1,y}if(s){var at=s.closest(".app-listview"),c=at.closest(".app-echo"),d=s.closest(".dv-item").find(".app-field").filter(r),rt;if(et=at.is(".app-grid"),d.each(function(n){if($(this).is(s))return rt=n,!1}),ut)switch(h){case"enter":h="up"}it||h!=="enter"||(h="down");tt=c.length>0&&!it;h==="tab"&&(ut?rt?h="left":a(s,"above")?(s=d[d.length-1],ot(),tt&&(h="up")):tt&&(h="up"):rt===d.length-1?a(s,"below")?(s=d[0],ot(),tt&&(h="down"),v(k,0)):tt&&(h="down"):h="right");switch(h){case"right":s=d[rt+1];(et||!s)&&(y=!0);break;case"left":s=d[rt-1];s||(y=!0);break;case"home":it||lt?(c.length||t.scrollable(s).scrollTop(0).closest(".ui-page").find(".app-bar-heading").hide(),l=s.closest(".app-listview").find(".dv-item .ui-btn:not(.app-calculated)").first(),l.is(".app-selected")||f(l),g.preventDefault(),s=null):(s=d[0],v(k,0));t.fetchOnDemand();break;case"end":it||lt?(c.length||(ft=t.scrollable(s),ft.length&&ft.scrollTop(ft[0].scrollHeight)),l=s.closest(".app-listview").find(".dv-item .ui-btn:not(.app-calculated)").last(),l.is(".app-selected")||f(l),g.preventDefault(),s=null):s=d[d.length-1];it&&t.fetchOnDemand();break;case"down":case"up":p=h==="down";tt?(l=s.closest(".dv-item"),b=(p?l.next():l.prev()).find(".ui-btn"),!b.length||b.is(".app-calculated,.dv-action-see-all")||b.parent().is(".app-hidden")?(nt=c.find(".dv-action-see-all").filter(r).find(".app-btn-"+(p?"next":"prev")),nt.length&&!nt.is(".app-btn-disabled")?(c.data("auto-highlight",p?"first":"last"),nt.trigger($.Event("vclick",{feedback:!1}))):(n._moving=!1,w(g)!=38&&w(g)!=40&&i.move($("#"+c.data("for")+"_ph"),h))):(f(b),n.scrollIntoView()),s=null,y=!0):s=null;break;case"enter":s.closest(".ui-page").is(".ui-page-active")?(t.lastTouch(!1),n._dataItemSelect=!1,s.trigger("vclick"),n._dataItemSelect=!0,t.lastTouch(!0),y=!0):s=null;break;default:s=null}s&&(ot(),y=!0)}else h!=="tab"&&h!=="down"&&h!=="up"||k||(p=h==="down"||h==="tab"&&!ut,c=t.summary(o().find('.app-focus[data-input="dataview"]')),c.length&&(k=e(c.data("for")),l=c.find(".app-listview .dv-item .app-selected").parent(),st=k.inlineEditing(),(st||!l.length)&&p?(ht=c.find(".dv-item:not(.app-calculated)").first().find(".app-field").filter(r).first(),ht.length&&(w(g)===40||!c.data("skip-item-focus"))?f(ht):i.move($("#"+c.data("for")+"_ph"),ut?"up":"down")):st?i.move($("#"+c.data("for")+"_ph"),"up"):h==="tab"?i.move($("#"+c.data("for")+"_ph"),p?"down":"up"):(b=(p?l.next():l.prev()).find(".ui-btn"),!b.length||b.is(".app-calculated,.dv-action-see-all")||b.parent().is(".app-hidden")?(nt=c.find(".dv-action-see-all").filter(r).find(".app-btn-"+(p?"next":"prev")),nt.length&&!nt.is(".app-btn-disabled")?(c.data("auto-highlight",p?"first":"last"),nt.trigger($.Event("vclick",{feedback:!1}))):i.move($("#"+c.data("for")+"_ph"),p?"down":"up")):(t.makeVisible(b),f(b))),y=!0));if(n._moving=!1,h==="space"&&k&&k.multiSelect()){var ct=n.dataItem().find(".app-btn-check"),vt=ct.closest(".ui-btn"),yt=ct.is(".app-btn-check-selected")&&k._selectedKeyList.length==1;ct.trigger("vclick");yt?n.detach():vt.is(".app-selected")||n.scrollIntoView(vt.closest(".app-listview").find(".ui-btn.app-selected"));y=!0}return y||h!=="tab"||$(document.activeElement).closest("[data-input]").length||i.focus({container:o()}),y},supports:function(n,i){var r=[],u=!1,f=n._viewId;return i==="New"?(r=n.actionGroups("Grid"),r.length&&r[0].Actions.every(function(n){var t=n.CommandArgument;return n.CommandName!==i||t&&t!==f||(u=!0),!u})):(t.contextScope(n._id),t.navContext(r),t.contextScope(null),r.every(function(n){var t=n.argument;return n.command!==i||t&&t!==f||(u=!0),!u})),u},toggleBool:function(i,r){if(!t.busy()){r||(r=n.dataView());var v=h(i),e=r.findFieldUnderAlias(v),y=r.row(),f=e.Items,o=y[e.Index],a=!e.isReadOnly()&&n.supports(r,"Edit"),c=f[f.length-(o===f[f.length-1][0]?2:1)][0];a?(c=a?f[f.length-(o===f[f.length-1][0]?2:1)][0]:o,i.removeClass("material-icon-check-box-outline-blank material-icon-check-box").addClass("material-icon-check-box"+c?"":"-outline-blank").find("i").text("check_box"+(c?"":"_outline_blank")),u.execute({command:"Update","in":r,values:[{field:e.Name,value:o,newValue:c}]}).then(function(n){r.sync();s(n.errors)})):s(l(e))}},clearField:function(i,r){if(!t.busy()){r||(r=n.dataView());i||(i=n.fieldElem(r));var b=h(i),f=r.findFieldUnderAlias(b),y=f.isReadOnly()||!n.supports(r,"Edit"),k=!y&&f.AllowNulls,e=null,p=[],o,w=u._fieldMapRegex,a,d=r.row(),v=[f];if(k){if(f.Index!==f.AliasIndex&&v.push(r._allFields[f.AliasIndex]),o=f.Copy,o)for(a=w.exec(o);a;)f=r.findField(a[1]),f&&v.push(f),a=w.exec(o);v.forEach(function(n){e=null;var t=i.closest(".dv-item").find(".app-field-"+n.Name);t.is(".app-field-type-bool")?(t.find("i").val("check_box_outline_blank"),n.AllowNulls||(e=!1)):t.text(c.Data.NullValueInForms);e==null&&t.addClass("app-null");p.push({field:n.Name,value:d[n.Index],newValue:e})});u.execute({command:"Update","in":r,values:p}).then(function(n){r.sync();s(n.errors)})}else s(y?l(f):c.Validator.Required)}},activate:function(r){var a,e,y,ut,d,p;if(!n._pending&&!t.busy()&&!t.isInTransition()){$(".app-bar-notify:not(.app-hidden").data("cancel",!1).trigger("vclick");n._activateInterval=null;t.fetchOnDemand();var f=n.dataView(),o,tt,w,v,ot=r&&r.toggle,b=!1;if(f&&!n._active&&f.inlineEditing()){if(o=n.fieldElem(f),!o.length)return b;tt=h(o);var k=f.findFieldUnderAlias(tt),it=f.get_tag(),c,rt=nt(k);if(rt||(a=n.supports(f,"Edit"),a?c="Edit":n.supports(f,"New")&&(a=f.rowIsTemplate(f.extension().commandRow()),c="New")),a){if(ot&&a&&k.Type==="Boolean"){n.toggleBool(o);return}n._fieldName=k.Name;n._active=!0;n._elem=o;f._tagList=null;w=o.closest(".dv-item");w.find(".app-row-status:not(.app-row-status-new)").addClass("app-row-status-edit");f._tag=(it||"")+" transition-none action-buttons-none content-stub-none page-header-none modal-always modal-title-none modal-tap-out modal-dock-top modal-auto-grow modal-background-transparent modal-max-xs";v=w.find(".ui-btn").data("data-context");v&&(c!=="New"||!f.tagged("optimistic-default-values-none"))&&(e=u.parseJSON(f.session("getPageTemplate")),e&&(y=!0,e.Fields.every(function(n){var t=n.ItemsStyle;return t&&(t.match(/DropDownList|ListBox|RadioButtonList/)&&(n.Items==null||!n.Items.length)||n.ItemsTargetController)&&(y=!1,n.ContextFields&&(ut=!0)),y}),ut||(y?(c==="New"?(e.Rows=[],e.NewRow=v.row,e.Inserting=!0,d=f._controller,f.odp||u.execute({controller:d,view:f._viewId,requiresNewRow:!0,background:!0}).done(function(n){function o(){i.execute({values:u})}var r=n[d][0],u=[],f,e;if(r)for(f in r)e=r[f],e!=null&&u.push({name:f,value:e});u.length&&(t.isInTransition()?t.whenPageShown(o):o())})):e.Rows=[v.row],e.Tag=(e.Tag||"")+f._tag+" view-type-inline-editor",e.SupportsCaching=!1,u.odp.response("GetPage",e)):f._tag+=" system-replacegetpagetemplate")));c==="New"&&(f._copyExternalLookupValues(),p=f._ditto,p&&p.length&&(n._ditto=p.slice(0)));f._showModal({commandName:c,commandArgument:f.get_viewId()});f._tagList=null;f._tag=it;b=!0}else{i._buffer=null;var g=f.headerField(),ft=f.extension().commandRow(),et=f.get_view().Label;g&&ft&&(headerFieldValue=ft[g.Index]);headerFieldValue&&(et=g.format(headerFieldValue));rt||s(l(et))}}return b}},expandBy:function(i,r){var f=i.closest(".app-page-inlineeditor-overlay"),e,u,s,h,c,o,l=!1,a;return f.length&&(h=t.dataView().session("targetDataView"),c=h.elem.closest(".app-wrapper"),o=c[0].getBoundingClientRect(),e=f.find(".app-wrapper"),scrollableRect=e[0].getBoundingClientRect(),u=Math.min(e.width()+r+3,Math.min(800,o.width*.75)),a=n.frame()[0].getBoundingClientRect(),u=Math.ceil(Math.max(u,a.width)),e.css({minWidth:u,maxWidth:u}),f.css({minWidth:u,maxWidth:u}).data("overlay",{w:u,f:i.closest("[data-field]").data("field")}),s=f[0].getBoundingClientRect(),s.right>o.right&&f.css("left",o.right-s.width-11),l=!0),l},form:function(n){var t=[];return t.push('<div data-layout="form" data-layout-size="xs" class="app-form-inlineeditor"><div data-container="simple" data-wrap="true" data-density="relaxed"><i class="app-icon material-icon material-icon-arrow-back" title="'+tt.CancelButton+'">arrow_back<\/i><i class="app-icon material-icon material-icon-more app-btn-more" title="'+b.More+'"><\/i>'),n._fields.forEach(function(n){var i=n.Name;n.Type!=="DataView"&&t.push('<div data-container="row" data-visible-when="$app.touch.edit.field(\''+i+'\')"><div class="app-form-inlineeditor-label"><span data-control="label" data-field="'+i+'"><span class="app-control-inner"><\/span><\/span><\/div><span data-control="field" data-field="'+i+'" data-auto-expand="true"><span class="app-control-inner"><\/span><\/span><\/div>')}),t.push("<\/div><\/div>"),t.join("\n")},position:function(i){var g=!rt(),nt=i.find(".app-wrapper"),st=nt.find(".app-form-inlineeditor"),y=n.field(),ht=st.find('[data-control="field"][data-field="'+y+'"]'),ct=ht.data("input")||"",p=!ct.match(/blob|checkboxlist/),o,ot,h,k;if(i.addClass("app-page-inlineeditor").toggleClass("app-custom-density-disabled",g).removeClass("app-page-inlineeditor-overlay"),g){i.data("trackPosition",!1);var tt=t.pageInfo(i.attr("id")).dataView,it=tt.session("targetDataView"),r=it?it.elem:n._elem,w,s,a,ut,b,u,e,ft,et;if(p&&(et=tt.findField(y),et.ItemsTargetController&&(p=!1)),p)o=i.addClass("app-page-inlineeditor-overlay").toggleClass("app-page-inlineeditor-textalignright",r.css("text-align")==="right").data("overlay"),ot=i.data("positioned"),o=o&&o.f===n.field()?o:null,ft=r.closest(".app-grid").length>0,ft&&i.addClass("app-page-inlineeditor-gridstyle"),w=r.find(".app-field-data"),w.length&&(r=w),s=r[0].getBoundingClientRect(),r.is(".app-field-type-bool")&&(s=n._frame[0].getBoundingClientRect()),i.css({maxHeight:"",minHeight:"",height:"",width:"",minWidth:"",maxWidth:""}),u=o!=null?o.w:s.width+2,e=Math.round(s.height),a=Math.round(s.left)-1,ut=Math.round(s.top),b=t.scrollable(r)[0].getBoundingClientRect(),a+u-1>b.right&&(u=b.right-a-9),i.css({left:a,top:ut,maxHeight:e,minHeight:e,height:e,Width:u,minWidth:u,maxWidth:u}),nt.css({maxHeight:e,minHeight:e,height:e,width:u,minWidth:u,maxWidth:u}),ot||(i.data("positioned",!0),h=$('.ui-page-active [data-field="'+y+'"] .app-data-input-button'),h.length&&(k=$('<span class="app-control-inner">w<\/span>').appendTo(h.parent()),h.css({top:(k.outerHeight()-h.outerHeight())/2,marginTop:""}),k.remove()));else{if(t.resetPageHeight(i),r){var c=r[0].getBoundingClientRect(),f=i[0].getBoundingClientRect(),l=f.left,v=f.top,d=t.screen();f.height+c.bottom+8<d.height?v=c.bottom+8:c.top-8-f.height>0&&(v=c.top-8-f.height);l=c.left-4;l+f.width-1>d.width&&(l=d.width-4-f.width)}(f.top!==v||f.left!==l)&&i.css({left:l,top:v})}i.data("trackPosition",!0)}else t.resetPageHeight(i)}};$(document).on("dataitemselect.dataview.app",function(i){if(i.namespace==="app.dataview"&&n._dataItemSelect!==!1){var f=t.lastTouch(),o,u,s,e=i.dataView;e.inlineEditing()&&(f&&(o=$(document.elementFromPoint(f.x,f.y)),u=o.closest(".app-field"),u.length||e.extension().viewStyle()!=="Grid"||o.find(".app-field").filter(r).each(function(){var t=this,n=t.getBoundingClientRect();if(f.x<n.left||n.left<=f.x&&f.x<=n.right)return u=$(t),!1}),u.length||(s=o.closest(".dv-item"),s.length&&(fieldName=(e.session("dataEditor")||{}).fieldName,fieldName&&(u=s.find(".app-field-"+fieldName))),u.length||(u=s.find(".app-field").first())),u.length||(u=null)),n.sync({dataView:e,elem:u,scrollIntoView:!0,ignoreOtherInputs:!0,allowToggle:!0}),i.action==="select"&&e.extension()._autoSelect&&setTimeout(t.executeInContext),i.preventDefault())}}).on("resizing.app",function(t){t.namespace==="app"&&n.detach()}).on("clear.dataview.app",function(){n.detach()}).on("keyboardnavigation.app",function(t){var r=t.originalEvent,i=t.direction;if(t.namespace==="app"&&!n._active)if(i==="edit"){if(n.activate())return!1}else{if(i==="space"&&n.frame(":active")&&n.fieldElem().is(".app-field-type-bool"))return n.toggleBool(n.fieldElem()),!1;if(n.move({direction:i,originalEvent:r}))return!1}}).on("keyboardpreview.app",function(t){if(n.frame(":active")){var r=t.originalEvent,u=r.key||"";u.length!==1&&!u.match(/Backspace|Del|Delete/)||r.ctrlKey||r.altKey||r.metaKey||(clearTimeout(k),i.barcode(":input")||(u.match(/Del|Delete/)?n.clearField():(i._buffer=u,t.preventDefault(),k=setTimeout(g,32))))}}).on("showcontextmenu.app",function(i){function s(n){t.lastTouch(!1);n.trigger("vclick");t.lastTouch(!0);c=!1}var u=n.fieldElem(),f=i.originalEvent,e,c,h;return u?(e=u.closest(".app-echo"),f.shiftKey&&e.length?s(e.find(".app-echo-toolbar .app-btn-more")):f.ctrlKey&&s(u.closest(".dv-item").find(".app-btn-more"))):f.ctrlKey&&(h=o()[0].getBoundingClientRect(),y(".app-listview .app-selected .app-btn-more").filter(r).each(function(){var n=this.getBoundingClientRect();if(n.top>h.top&&n.top<h.bottom)return s($(this)),!1})),c}).on("mousedown",".app-focus-frame",function(){t.clearHtmlSelection()}).on("vclick",".app-focus-frame",function(i){if(i.type==="vclick"){var r=n.fieldElem(),u=r.is(".app-field-type-bool");t.pointer("touch")?setTimeout(n.activate,0,{toggle:u}):u&&t.touched(r.find("i"))&&setTimeout(n.toggleBool,0,r)}}).on("contextmenu taphold",".app-focus-frame",function(){n.frame().hide();var i=t.lastTouch(),r=document.elementFromPoint(i.x,i.y);n.frame().show();$(r).trigger("contextmenu")}).on("dblclick",".app-focus-frame",function(){t.pointer("mouse")&&setTimeout(n.activate,0,{toggle:!0})}).on("generatelayout.dataview.app",function(t){t.dataView._inlineEditor&&(t.layout=n.form(t.dataView))}).on("pagepositionchanged.app",function(t){n.position(t.page)}).on("pagereadycomplete.app",function(t){var i=n.instance(),c=n._elem,u,r,f,o,s,h;if(i)if(n.position(t.page),n._active=!0,t.reverse)p(i);else if(c){if(s=e(i._parentDataViewId),i._inlineFields=ut(s),i.session("targetDataView",{id:s._id,elem:c}),n._elem=null,i.inserting()&&!i._newRowBroadcasted){i._newRowBroadcasted=!0;u=i.data();r=[];for(f in u)o=u[f],o!=null&&r.push({name:f,value:o});r.length&&(n._broadcastValues(i,r),n.position(t.page))}}else p(i);else n._active=!1;h=n._lastSyncOptions;h&&(n._lastSyncOptions=null,n.sync(h));n.commit(t)}).on("dataviewrefresh.app",function(i){n.commit(i);var r=i.dataView,u=r.session("inlineEditor"),f;u!=null&&(f=r._autoNewRow,r.gridChanged(),t.stickyHeaderBar().hide(),t.stickyHeader(),r.session("inlineEditor",null),u&&(f?(d(r),r._autoNewRow=!1):g()))}).on("datainputbroadcast.app",function(t){var i=t.dataView;i._inlineEditor&&n._broadcastValues(i,t.values)}).on("datainputmove.app",function(u){var o,e,f,s,h,c;if(n.frame(":visible")&&(o=t.dataView(),o&&o._inlineEditor)){if(f=u.direction,f&&typeof f!="string"){if(f.closest(".app-focus-frame").length)return setTimeout(function(){i.focus({lastFocused:!0})}),!1;if(e=f.closest(".app-field"),e.length||(h=t.lastTouch(),h&&f.closest(".app-grid").length?f.closest(".dv-item").find(".app-field").filter(r).each(function(){var n=this.getBoundingClientRect();if(h.x<n.left||n.left<=h.x&&h.x<=n.right)return e=$(this),!1}):f.closest(".app-listview").length||(s=(f.attr("class")||"").match(/\bapp\-field\-(\w+)\b/),s&&s[1]!==n.field()&&(e=o.session("targetDataView").elem.closest(".dv-item").find("."+s[0]),e.length&&n.field(s[1])))),e.length){if(u.direction=e,c=o.session("targetDataView"),!e.closest(".app-listview").is(c.elem.closest(".app-listview")))return}else return}u.fromDataInput||(u.fromDataInput=t.pageInfo().scrollable.find('[data-input][data-field="'+n.field()+'"]'));n.moveInput(u)}}).on("dataviewignorechanges.app",function(t){var i=t.dataView;i._inlineEditor&&n.undo(i)}).on("inlineeditingmode.dataview.app",function(i){var r=i.dataView,u=r.extension(),a=u.commandRow(),e=i.inlineEditing,s,h,c,l=i.newRow,v;if(e){if(s=o(),h=t.pageInfo(),c=h&&h.dataView===r?s.find(".app-listview .dv-item .ui-btn").first():s.find('.app-echo[data-for="'+r._id+'"] .app-listview .dv-item .ui-btn').first(),t.lastTouch(!1),l){if(d(r))return}else a?u.tap(a,"highlight"):f(c);t.lastTouch(!0);u.viewStyle().match(/(Grid|List|Cards)/)&&(r.inlineEditing()||r.inlineEditing(e,!i.editor),v=n.frame(),n.sync({dataView:r,elem:c.find("app-field-"+r._fields[0].Name)}),l||t.makeVisible(v),r.session("inlineEditor",i.editor))}else r.inlineEditing(e),n.detach();t.scrollGrid(r,!0);l?(r._autoNewRow=!0,u.pageIndex(Math.ceil(r._totalRowCount/r._pageSize)-1),u._reset=!0,u.refresh()):r.sync()}).on("vclick",'.app-form-inlineeditor [data-container="simple"] .material-icon',function(n){var t=$(n.target);return t.is(".material-icon-arrow-back")?history.go(-1):$(document).trigger($.Event("keydown",{keyCode:121,shiftKey:!0})),!1})})();