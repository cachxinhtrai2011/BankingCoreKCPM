/*!
* Data Aquarium Framework - Touch UI Input & Keyboards
* Copyright 2021 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function it(t,i){var p=t&&t.match(/^(.+?)\-auto$/),r,u,s,h,c,f,l,e,o,a,y;if(!i)if(p)t=p[1];else if(w("touchOnly")!==!1&&!n.pointer("touch")||t&&w(t+".enabled")===!1)return null;if(r=v[t],r&&(u=r._html,!u)){for(r._type=t,u=['<div class="app-keyboard" type="',t,'">'],s=0;s<r.length;s++){for(c=r[s],u.push('<div class="app-row">'),h=0;h<c.length;h++)f=c[h],e=f.key||"",macro=f.macro,o=f.hint,y=f.alt,a=f.text,typeof e=="function"&&(e=e()),l=f.icon,u.push('<span data-draggable="keyboard-key" class="app-key ',f.accent?" app-accent":"",o?" app-has-hint":"",e.length===1&&!o||y?" app-simple":"",'" data-key="',e,'"',y?' data-alt="'+y+'"':"",macro?' data-macro="'+macro+'"':"",' style="',"width:",100/c.length,"%",'">',l?'<i class="material-icon">'+l+"<\/i>":"",l?"":'<span class="app-text',a?" app-text-small":"",'">'+(a?a:e)+"<\/span>",o?'<span class="app-hint">'+(typeof o=="string"?o:"&nbsp;")+"<\/span>":"","<\/span>");u.push("<\/div>")}u.push('<div class="app-row app-row-controls"><span data-draggable="keyboard-key" class="app-key" data-key="Escape" style="width:',100/r[0].length,'%"><i class="material-icon">expand_more<\/i><\/span><\/div>');u.push("<\/div>");r._html=u.join("")}return r}function wt(t){var f=$(t.target),i=f.data("type"),r;return r=it(i),r?(i=r._type,e.keyboard(function(){vt("kbd-"+i,r._html,{input:f,inputPage:u().data({"last-focused-field":null}),inputValue:t.inputValue,inputValueRaw:t.inputValueRaw,inputDataType:t.inputDataType,inputMaxLength:t.inputMaxLength,placeholder:t.placeholder,inline:n.dataView()._inlineEditor,format:t.inputFormat,type:i})}),!1):void 0}function ct(n){return n+'<span class="app-cursor">|<\/span>'}function f(){return $(".app-modal-keyboard")}function p(n){return(n||f()).is(".app-modal-keyboard-bottom")}function w(t){return n.settings("ui.keyboard."+t)}function rt(){var t=u(".app-keyboard .app-key .app-hint"),n=0,i=0,r;t.each(function(){var t=$(this),r=o(t),u=t.prev(),f=r.width,e=Math.ceil(r.left-o(u).left);f>n&&(n=Math.ceil(f));e>i&&u.text().length===1&&(i=e)});n&&(r=t.first().parent().width(),t.each(function(){$(this).width(n).prev().css("margin-left",(r-i-n)/2)}))}function lt(){rt();b("sync")}function b(t){var f=$(".app-page-modal-glass-pane"),r=f.find(".app-inner"),u,i;if(t===!0)r.length||tt("app-inner-scroller").appendTo(tt("app-inner").appendTo(f).css("right",-n.scrollable("scrollbar").width)),b("sync");else if(t===!1)r.remove();else if(u=s(),u&&!u.inline){i=n.scrollable(u.inputPage);r.find(".app-inner-scroller").height(i[0].scrollHeight-i.height()+g.height());r.data("target",i).off("scroll",at).scrollTop(i.scrollTop()).on("scroll",at)}}function at(){var n=$(this);cancelAnimationFrame(st);st=requestAnimationFrame(function(){n.data("target").scrollTop(n.scrollTop())})}function k(t,i,r){var f=n.scrollable(i),u=o(i),e=o(t),s=o(f),h=f.scrollTop();u.top<s.top?(f.scrollTop(h-(s.top-u.top+12)),u=o(i),u.bottom>e.top&&f.scrollTop(f.scrollTop()-(e.bottom-u.top+4))):p(t)?u.bottom>e.top&&f.scrollTop(h+(u.top-e.top+u.height+12)):s.top>u.top?(f.scrollTop(h-(s.top-u.top)-12),r&&n.resetPageHeight(t)):s.bottom<u.bottom?(f.scrollTop(h+(u.bottom-s.bottom)+12),r&&n.resetPageHeight(t)):e.top<=u.top&&u.top<=e.bottom&&(f.scrollTop(h+(u.bottom-e.top)+12),u=o(i),u.bottom>e.top&&u.bottom<e.bottom&&f.scrollTop(f.scrollTop()-(e.bottom-u.top+4)))}function bt(t){function a(){r.css({transform:"",transition:""});h.addClass("app-has-keyboard");l||n.isInTransition(!1);n.scrollable("focus")}var u=n.hasFocus(t.input),o=t.inputPage,s=u.find(".app-control-inner"),v=t.value,c,r=f(),e,l;if(rt(),u.find(".app-cursor").length||u.data("originalHtml",s.html()),c=t.inputValueRaw==null&&t.placeholder?'<span class="app-cursor">|<\/span><span class="app-placeholder">'+i.htmlEncode(t.placeholder)+"<\/span>":ct(v),s.html(c),e=o.find(".app-stub-keyboard"),e.length||(e=tt("app-stub-keyboard").insertAfter(u.closest("[data-layout]"))),e.height(t.inline?0:Math.max(e.height(),r.outerHeight())),k(r,u,!0),$(".app-page-modal-glass-pane").insertBefore(r),b(!0),o.data("keepKbdOpen"))o.removeData("keepKbdOpen"),h.addClass("app-has-keyboard");else if(l=n.isInTransition(),n.isInTransition(!0),r.css("visibility",""),p(r)&&!h.is(".app-has-keyboard")){r.css("transform","translate3d(0,100%,0)").one("transitionend",a);setTimeout(function(){r.css("transition","transform 150ms ease-out");setTimeout(function(){r.css("transform","")})})}else{r.css("transform","scale(.75)").one("transitionend",a);setTimeout(function(){r.css("transition","transform 150ms ease-out");setTimeout(function(){r.css("transform","")})})}}function kt(t){function ut(){h.removeClass("app-has-keyboard");b(!1);f().css("visibility","hidden");y.find(".app-stub-keyboard").remove();n.scrollable("refresh");tt()||a.trigger("keyboardclosed.app")}function tt(){return r&&(nt?setTimeout(e.move,0,i,s==="down"?"right":"left",8):c?setTimeout(e.focus,0,{fieldName:r}):setTimeout(e.move,0,i,s,13)),r}var v=t.value,o,i=t.input,y=t.inputPage,w,k,s=t.shift?"up":"down",r=t.enter||t.tab,nt=t.inline,c,l,rt;if(g.off("throttledresize",lt),a.off("keydown",yt),t.shift=t.tab=t.enter=!1,v!=t.inputValue){if(o=e.triggerSetValue(t.input,v,t.inputValue),!o.inputValid){n.vibrate();e.valid(!0);n.notify({text:o.inputError,force:!0});vt(null,null,t);return}}else w=i.find(".app-control-inner"),k=i.data("originalHtml"),i.removeData("originalHtml"),w.html(k);if(n.hasFocus(i,!1),r&&!nt&&(c=typeof r=="string",l=c?u('[data-control="field"][data-field="'+r+'"]').first():e.move(i,s,13,null,!0),rt=it($(l).data("type")),rt)){f().data("mini")?h.removeClass("app-has-keyboard"):(y.data("keepKbdOpen",!0),i.is(l)&&!p()&&n.whenPageShown(function(){d(et)}));tt();return}d(ut)}function d(n){function i(){t.css({transform:"",transition:""});n()}var t=f();if(p()&&!t.data("mini")){t.css({transition:"transform 100ms ease-in"}).one("transitionend",i);setTimeout(function(){t.css("transform","translate3d(0, 100%,0)")})}else t.fadeOut(100,i)}function vt(t,r,f){n.whenPageShown(function(){bt(f);g.on("throttledresize",lt);a.on("keydown",yt);n.whenPageShown(function(){n.stickyHeaderBar().hide();setTimeout(kt,0,f)})});t?(f.value=f.inputValue,i.survey({controller:t,context:f,topics:[{questions:{name:"k"}}],options:{modal:{fitContent:!0,always:!0,max:n.toWidth("tn"),title:!1,tapOut:!0,dock:"top",background:{transparent:!0,clear:u().is(".app-reading-pane-master,.app-reading-pane-detail")},keyboard:!0},transition:!1,actionButtons:!1,discardChangesPrompt:!1,contentStub:!1,trackContent:!0},layout:r})):l(1)}function dt(t){var i=t.rect,v=i.page,e=i.dataView,s,u,f,c,l,r,a;if(e&&e.tagged("modal-keyboard")){if(l=e._survey.context,s=l.input,s.parent().length){if(u=o(s),!u.width)return;r=n.screen();c=r.width<n.toWidth("sm");f=v.toggleClass("app-modal-keyboard-bottom",c).find(".app-keyboard");i.height=f.length?f.outerHeight():1;c?(i.left=r.left,i.width=r.width,i.height=f.outerHeight(),i.right=r.right,i.top=r.top+r.height-i.height):(i.left=u.left,a=v.find(".app-keyboard"),a.length&&(i.left+=h.is(".app-input-focus-outline")?-2:parseFloat(a.css("padding-left"))-1),i.top=u.bottom+12,i.width=w(l.type+".width")||360,i.top+i.height-1>r.top+r.height-1&&(i.top=u.top-i.height-5),i.left+i.width-1>r.left+r.width-1&&(i.left=r.left+r.width-1-i.width),(i.top<r.top||i.top+i.height-1>r.top+r.height-1)&&(i.bottom=r.top+r.height-1,i.top=i.bottom-i.height+1))}return!1}}function s(){var t=n.dataView(),i=t&&t._survey;return i?i.context:null}function ut(n){var t=[],f=s(),i=f.input,r,e=f.placeholder,u;return i.find(".app-control-inner").contents().each(function(){var n=$(this);n.is(".app-cursor,.app-placeholder")||t.push(n.text())}),t=t.join(""),u=!t.length,i.toggleClass("app-null",u),n&&e&&(u?(r=i.find(".app-control-inner"),r.find(".app-placeholder").length||ht("app-placeholder").text(e).appendTo(r)):i.find(".app-control-inner .app-placeholder").remove()),t}function ft(n,t,i){var a=n.find(".app-control-inner"),p=a.contents(),u=p[i==="before"?0:2],r,e,y,o,h,l,f;if(u&&u.nodeType===3||(u=$(document.createTextNode("")),i==="before"?u.insertBefore(n.find(".app-cursor")):u.appendTo(a),u=u[0]),r=u.nodeValue,r==null&&(r=""),t==null?r=null:t.length?t==" "&&r.endsWith(" ")||(r+=t):r=r.substring(0,r.length-1),e=n.data("type"),y=v[e],e==="number"&&y&&w(e+".format")&&(o=s().format,o)){if(h=String.localeFormat(o,0),l=h.indexOf(c),r=r.replace(/\D/g,""),l>=0)if(f=h.length-l-1,t===c)for(r+=c;f--;)r+="0";else r.length<f+2&&(r="0"+r),r=r.substring(0,r.length-f)+c+r.substring(r.length-f);r=Number.parseLocale(r);r=r==0&&t!==c?t==="0"?"0":"":String.localeFormat(o,r)}u.nodeValue=r}function et(){f().data("mini",!0).css("visibility","hidden");s().inputPage.find(".app-stub-keyboard").height(0)}function l(t){n.isInTransition(!0);history.go(t||-1)}function yt(t){function c(){return h.find("[data-key] .app-text").filter(function(){return $(this).text().toLowerCase().startsWith(r.toLowerCase())}).first().parent()}var h=$(this),r=t.key,i,e=s(),o;if(!e||n.isInTransition())return!1;if(i=c(),i.length||(i=h.find('[data-key="'+r+'"]')),i.length||r.length!==1||(o=u("[data-alt]"),o.length&&(y._insert({target:o},0),i=c(),(!i.length||i.is("[data-alt]"))&&y._insert({target:u("[data-alt]")},0))),!i.length||t.ctrlKey||t.altKey){if(r=="ArrowDown"&&t.altKey)return f().data("mini")?(e.enter=e.input.data("field"),l()):d(et),!1;if(r.match(/Tab|Arrow(Up|Down)/))return e.tab=!0,e.shift=t.shiftKey||r==="ArrowUp",l(),!1}else return i.addClass("app-dragging"),y._insert({target:i},0),clearTimeout(i.data("timeout")),i.data("timeout",setTimeout(function(){i.removeClass("app-dragging")},150)),!1}function gt(t){if(n.pointer("touch")){var f=$(t.target),r=i.input.elementToField(f),h=r._dataView,c=h.editRow()[r.Index],l={inputContainer:f,field:r,dataView:h,modal:!0,date:c},o=f.find(".app-cursor"),s;if(!r.tagged("calendar-input-disabled"))return e.keyboard(function(){n.CalendarInput("attach",l);n.CalendarInput("focus",l);o.length||(s=f.find(".app-control-inner"),o=ht("app-cursor").text("|"),r.Watermark&&c==null?o.insertBefore(s.contents()):o.appendTo(s));n.tooltip(!1);u().removeData("lastFocusedField")}),!1}t.dataType=null}var i=$app,e=i.input,n=i.touch,a=$(document),g=$(window),h=$("body"),o=i.clientRect,r=Web.DataViewResources.Mobile.Keyboard.TelHints,pt=Sys.CultureInfo.CurrentCulture,ot=pt.numberFormat,c=ot.NumberDecimalSeparator,u=n.activePage,v={number:[[{key:"1"},{key:"2"},{key:"3"},{key:"-"}],[{key:"4"},{key:"5"},{key:"6"},{key:" ",icon:"space_bar"}],[{key:"7"},{key:"8"},{key:"9"},{key:"Backspace",icon:"backspace"}],[{key:function(){return ot.NumberGroupSeparator}},{key:"0"},{key:function(){return c}},{key:"Enter",icon:"keyboard_return",accent:!0}]],tel:[[{key:"1",hint:r.Key1},{key:"2",hint:r.Key2},{key:"3",hint:r.Key3},{key:"-"}],[{key:"4",hint:r.Key4},{key:"5",hint:r.Key5},{key:"6",hint:r.Key6},{key:" ",icon:"space_bar"}],[{key:"7",hint:r.Key7},{key:"8",hint:r.Key8},{key:"9",hint:r.Key9},{key:"Backspace",icon:"backspace"}],[{key:"*",alt:"tel_alt",text:"* #",hint:!0},{key:"0+",hint:!0},{key:"."},{key:"Enter",icon:"keyboard_return",accent:!0}]],tel_alt:[[{key:"("},{key:"/"},{key:")"},{key:"-"}],[{key:"N"},{key:",",text:"Pause"},{key:","},{key:" ",icon:"space_bar"}],[{key:"*"},{key:";",text:"Wait"},{key:"#"},{key:"Backspace",icon:"backspace"}],[{key:"1",alt:"tel",text:"123"},{key:"+"},{key:"."},{key:"Enter",icon:"keyboard_return",accent:!0}]]},y,st,nt,t=i.html,ni=t.tag,ti=t.div,ii=t.span,ri=t.$tag,ui=t.$p,tt=t.$div,ht=t.$span,fi=t.$a,ei=t.$i,oi=t.$li,si=t.$ul;i.keyboard=function(){var n=arguments;return n.length&&(v[n[0]]=n[1]),v};y=i.dragMan["keyboard-key"]={start:function(n){var t=n.target;String.isNullOrEmpty(t.attr("data-key"))?n.cancel=!0:(n.dir="all",t.addClass("app-dragging"))},move:function(){},end:function(n){this.cancel(n)},cancel:function(t){var i=n.lastTouch();(!t.moved||$(document.elementFromPoint(i.x,i.y)).closest(".app-dragging").length)&&this._insert(t,0);t.target.removeClass("app-dragging")},taphold:function(n){var t=this._insert(n,1);return t!==!1&&(n.ignore=!0),t},_insert:function(t,i){if(!t.ignore){var f=s(),e=f.input,a=f.inputMaxLength,h=t.target,r=h.attr("data-key"),c=h.attr("data-macro"),v=h.attr("data-alt"),y,o=u();if(v&&!i)y=it(v,!0),u("[data-layout]").html(y._html),rt(),n.resetPageHeight();else{if(c)return c==="$clear"?ft(e,null,"before"):e.find(".app-control-inner").html(ct(c)),f.value=ut(!0),k(o,e),!1;if(r==="Backspace")return ft(e,"","before"),f.value=ut(!0),k(o,e),!1;if(r==="Enter")f.enter=!0,l();else if(r==="Escape")o.data("mini")?l():d(et);else if(!i||r.length>1)(!a||f.value.length<a)&&(r=r.charAt(Math.min(r.length-1,i)),ft(e,r,"before"),f.value=ut(!0),k(o,e));else return!1}}}};a.on("getpagerect.app",dt).on("showvalue.input.app","[data-type]",wt).on("showvalue.input.app",'[data-type="datetime"],[data-type="date"]',gt).on("touchstart pointerdown mousedown",".app-page-modal-glass-pane .app-inner",function(){nt=n.lastTouch()}).on("vclick",".app-page-modal-glass-pane .app-inner",function(t){var e,o,h=t.pageX,c=t.pageY,r,i,u,v;if(Math.abs(nt.x-h)<11&&Math.abs(nt.y-c)<11){if(e=$(this).parent().css("visibility","hidden"),o=$(".app-page-modal-background").css("visibility","hidden"),r=$(document.elementFromPoint(h,c)),i=r.closest("[data-field]"),o.css("visibility",""),e.css("visibility",""),i.length)u=s(),v=u.inputPage,i.closest(".ui-page").is(v)&&(u.enter=i.data("field"));else if(f().data("mini")||f().is(".app-modal-keyboard-bottom"))a.one("keyboardclosed.app",function(){n.invokeInTargetPage(function(){r.trigger("vclick")})});l()}return!1})})();